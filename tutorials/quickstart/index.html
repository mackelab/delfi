



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.4.3">
    
    
      
        <title>Tutorial - delfi</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/application.30686662.css">
      
        <link rel="stylesheet" href="../../assets/stylesheets/application-palette.a8b3c06d.css">
      
      
        
        
        <meta name="theme-color" content="#3f51b5">
      
    
    
      <script src="../../assets/javascripts/modernizr.74668098.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../../assets/fonts/material-icons.css">
    
    
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.10.2/dist/katex.min.css">
    
      <link rel="stylesheet" href="../../static/global.css">
    
    
      
    
    
  </head>
  
    
    
    <body dir="ltr" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="__github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#inference-on-hodgkin-huxley-model-tutorial" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="../.." title="delfi" class="md-header-nav__button md-logo">
          
            <img src="../../static/logo.svg" width="24" height="24">
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              delfi
            </span>
            <span class="md-header-nav__topic">
              
                Tutorial
              
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  

<a href="http://github.com/mackelab/delfi/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    mackelab/delfi
  </div>
</a>
          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main" role="main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="../.." title="delfi" class="md-nav__button md-logo">
      
        <img src="../../static/logo.svg" width="48" height="48">
      
    </a>
    delfi
  </label>
  
    <div class="md-nav__source">
      


  

<a href="http://github.com/mackelab/delfi/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    mackelab/delfi
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../.." title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../install/" title="Installation" class="md-nav__link">
      Installation
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Tutorial
      </label>
    
    <a href="./" title="Tutorial" class="md-nav__link md-nav__link--active">
      Tutorial
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#different-required-components" class="md-nav__link">
    Different required components
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#observed-data" class="md-nav__link">
    Observed data
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#model" class="md-nav__link">
    Model
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#prior-over-model-parameters" class="md-nav__link">
    Prior over model parameters
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#summary-statistics" class="md-nav__link">
    Summary statistics
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#generator-class" class="md-nav__link">
    Generator class
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#coming-back-to-the-observed-data" class="md-nav__link">
    Coming back to the observed data
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4">
    
    <label class="md-nav__link" for="nav-4">
      Reference
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        Reference
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../reference/distributions/" title="Distributions" class="md-nav__link">
      Distributions
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../reference/generator/" title="Generator" class="md-nav__link">
      Generator
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../reference/inference/" title="Inference" class="md-nav__link">
      Inference
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../reference/neuralnet/" title="Neural Networks" class="md-nav__link">
      Neural Networks
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../reference/utils/" title="Utilities" class="md-nav__link">
      Utilities
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../credits/" title="Credits" class="md-nav__link">
      Credits
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#different-required-components" class="md-nav__link">
    Different required components
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#observed-data" class="md-nav__link">
    Observed data
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#model" class="md-nav__link">
    Model
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#prior-over-model-parameters" class="md-nav__link">
    Prior over model parameters
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#summary-statistics" class="md-nav__link">
    Summary statistics
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#generator-class" class="md-nav__link">
    Generator class
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#coming-back-to-the-observed-data" class="md-nav__link">
    Coming back to the observed data
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="http://github.com/mackelab/delfi/edit/master/docs/tutorials/quickstart.ipynb" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                <h1 id="inference-on-hodgkin-huxley-model-tutorial">Inference on Hodgkin-Huxley model: tutorial<a class="headerlink" href="#inference-on-hodgkin-huxley-model-tutorial" title="Permanent link">&para;</a></h1>
<p>In this tutorial, we use <code>delfi</code> to do inference on a Hodgkin-Huxley model (Hodgkin and Huxley, 1952) with two parameters (<span class="arithmatex">\(\bar g_{Na}\)</span>,<span class="arithmatex">\(\bar g_K\)</span>), given a current-clamp recording (synthetically generated).</p>
<h2 id="different-required-components">Different required components<a class="headerlink" href="#different-required-components" title="Permanent link">&para;</a></h2>
<p>Before running inference, let us define the different required components:</p>
<p>(1) observed data</p>
<p>(2) model</p>
<p>(3) prior over model parameters</p>
<p>(4) summary statistics</p>
<p>(5) generator class.</p>
<h2 id="observed-data">Observed data<a class="headerlink" href="#observed-data" title="Permanent link">&para;</a></h2>
<p>Let us assume we current-clamped a neuron and recorded the following voltage trace:</p>
<p><img src="https://raw.githubusercontent.com/mackelab/delfi/master/docs/docs/tutorials/observed_voltage_trace.png" width="480">
<br></p>
<p>In fact, this voltage trace was not measured experimentally but synthetically generated by simulating a Hodgkin-Huxley model with particular parameters (<span class="arithmatex">\(\bar g_{Na}\)</span>,<span class="arithmatex">\(\bar g_K\)</span>). We will come back to this point later in the tutorial.</p>
<h2 id="model">Model<a class="headerlink" href="#model" title="Permanent link">&para;</a></h2>
<p>We would like to infer the posterior over the two parameters (<span class="arithmatex">\(\bar g_{Na}\)</span>,<span class="arithmatex">\(\bar g_K\)</span>) of a Hodgkin-Huxley model, given the observed electrophysiological recording above. The model has channel kinetics as in Pospischil et al. 2008, and is defined by the following set of differential equations (parameters of interest highlighted in orange):</p>
<p><img src="https://raw.githubusercontent.com/mackelab/delfi/master/docs/docs/tutorials/hh_equations.png?" />
<br></p>
<p>where <span class="arithmatex">\(V\)</span> is the membrane potential, <span class="arithmatex">\(C_m\)</span> is the membrane capacitance, <span class="arithmatex">\(g_{\text{l}}\)</span> is the leak conductance, <span class="arithmatex">\(E_{\text{l}}\)</span> is the membrane reversal potential, <span class="arithmatex">\(\bar{g}_c\)</span> is the density of channels of type <span class="arithmatex">\(c\)</span> (<span class="arithmatex">\(\text{Na}^+\)</span>, <span class="arithmatex">\(\text{K}^+\)</span>, M), <span class="arithmatex">\(E_c\)</span> is the reversal potential of <span class="arithmatex">\(c\)</span>, (<span class="arithmatex">\(m\)</span>, <span class="arithmatex">\(h\)</span>, <span class="arithmatex">\(n\)</span>, <span class="arithmatex">\(p\)</span>) are the respective channel gating kinetic variables, and <span class="arithmatex">\(\sigma \eta(t)\)</span> is the intrinsic neural noise. The right hand side of the voltage dynamics is composed of a leak current, a voltage-dependent <span class="arithmatex">\(\text{Na}^+\)</span> current, a delayed-rectifier <span class="arithmatex">\(\text{K}^+\)</span> current, a slow voltage-dependent <span class="arithmatex">\(\text{K}^+\)</span> current responsible for spike-frequency adaptation, and an injected current <span class="arithmatex">\(I_{\text{inj}}\)</span>. Channel gating variables <span class="arithmatex">\(q\)</span> have dynamics fully characterized by the neuron membrane potential <span class="arithmatex">\(V\)</span>, given the respective steady-state <span class="arithmatex">\(q_{\infty}(V)\)</span> and time constant <span class="arithmatex">\(\tau_{q}(V)\)</span> (details in Pospischil et al. 2008).</p>
<p>The input current <span class="arithmatex">\(I_{\text{inj}}\)</span> is defined by:</p>
<div class="codehilite"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>

<span class="k">def</span> <span class="nf">syn_current</span><span class="p">(</span><span class="n">duration</span><span class="o">=</span><span class="mi">120</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">t_on</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
                <span class="n">curr_level</span> <span class="o">=</span> <span class="mf">5e-4</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="n">t_offset</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="n">duration</span> <span class="o">=</span> <span class="n">duration</span>
    <span class="n">t_off</span> <span class="o">=</span> <span class="n">duration</span> <span class="o">-</span> <span class="n">t_on</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">duration</span><span class="o">+</span><span class="n">dt</span><span class="p">,</span> <span class="n">dt</span><span class="p">)</span>

    <span class="c1"># external current</span>
    <span class="n">A_soma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="p">((</span><span class="mf">70.</span><span class="o">*</span><span class="mf">1e-4</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># cm2</span>
    <span class="n">I</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="n">I</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">t_on</span><span class="o">/</span><span class="n">dt</span><span class="p">)):</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">t_off</span><span class="o">/</span><span class="n">dt</span><span class="p">))]</span> <span class="o">=</span> <span class="n">curr_level</span><span class="o">/</span><span class="n">A_soma</span> <span class="c1"># muA/cm2</span>

    <span class="k">return</span> <span class="n">I</span><span class="p">,</span> <span class="n">t_on</span><span class="p">,</span> <span class="n">t_off</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">A_soma</span>
</pre></div>

<p>The Hodgkin-Huxley simulator is given by:</p>
<div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">HHsimulator</span><span class="p">(</span><span class="n">V0</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">I</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Simulates the Hodgkin-Huxley model for a specified time duration and current</span>

<span class="sd">        Parameters</span>
<span class="sd">        ---------- </span>
<span class="sd">        V0 : float</span>
<span class="sd">            Voltage at first time step</span>
<span class="sd">        params : np.array, 1d of length dim_param</span>
<span class="sd">            Parameter vector</span>
<span class="sd">        dt : float</span>
<span class="sd">            Timestep</span>
<span class="sd">        t : array</span>
<span class="sd">            Numpy array with the time steps</span>
<span class="sd">        I : array</span>
<span class="sd">            Numpy array with the input current</span>
<span class="sd">        seed : int</span>
<span class="sd">        &quot;&quot;&quot;</span>

    <span class="n">gbar_Na</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># mS/cm2</span>
    <span class="n">gbar_Na</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">gbar_K</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>   <span class="c1"># mS/cm2</span>
    <span class="n">gbar_K</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>

    <span class="c1"># fixed parameters</span>
    <span class="n">g_leak</span> <span class="o">=</span> <span class="mf">0.1</span>    <span class="c1"># mS/cm2</span>
    <span class="n">gbar_M</span> <span class="o">=</span> <span class="mf">0.07</span>   <span class="c1"># mS/cm2</span>
    <span class="n">tau_max</span> <span class="o">=</span> <span class="mf">6e2</span>   <span class="c1"># ms</span>
    <span class="n">Vt</span> <span class="o">=</span> <span class="o">-</span><span class="mf">60.</span>       <span class="c1"># mV</span>
    <span class="n">nois_fact</span> <span class="o">=</span> <span class="mf">0.1</span> <span class="c1"># uA/cm2</span>
    <span class="n">E_leak</span> <span class="o">=</span> <span class="o">-</span><span class="mf">70.</span>   <span class="c1"># mV</span>
    <span class="n">C</span> <span class="o">=</span> <span class="mf">1.</span>          <span class="c1"># uF/cm2</span>
    <span class="n">E_Na</span> <span class="o">=</span> <span class="mi">53</span>       <span class="c1"># mV</span>
    <span class="n">E_K</span> <span class="o">=</span> <span class="o">-</span><span class="mi">107</span>      <span class="c1"># mV</span>

    <span class="n">tstep</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">seed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">RandomState</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">RandomState</span><span class="p">()</span>

    <span class="c1">####################################</span>
    <span class="c1"># kinetics</span>
    <span class="k">def</span> <span class="nf">efun</span><span class="p">(</span><span class="n">z</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">z</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-4</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">z</span><span class="o">/</span><span class="mi">2</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">z</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">z</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">alpha_m</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="n">v1</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-</span> <span class="n">Vt</span> <span class="o">-</span> <span class="mf">13.</span>
        <span class="k">return</span> <span class="mf">0.32</span><span class="o">*</span><span class="n">efun</span><span class="p">(</span><span class="o">-</span><span class="mf">0.25</span><span class="o">*</span><span class="n">v1</span><span class="p">)</span><span class="o">/</span><span class="mf">0.25</span>

    <span class="k">def</span> <span class="nf">beta_m</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="n">v1</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-</span> <span class="n">Vt</span> <span class="o">-</span> <span class="mi">40</span>
        <span class="k">return</span> <span class="mf">0.28</span><span class="o">*</span><span class="n">efun</span><span class="p">(</span><span class="mf">0.2</span><span class="o">*</span><span class="n">v1</span><span class="p">)</span><span class="o">/</span><span class="mf">0.2</span>

    <span class="k">def</span> <span class="nf">alpha_h</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="n">v1</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-</span> <span class="n">Vt</span> <span class="o">-</span> <span class="mf">17.</span>
        <span class="k">return</span> <span class="mf">0.128</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">v1</span><span class="o">/</span><span class="mf">18.</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">beta_h</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="n">v1</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-</span> <span class="n">Vt</span> <span class="o">-</span> <span class="mf">40.</span>
        <span class="k">return</span> <span class="mf">4.0</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.2</span><span class="o">*</span><span class="n">v1</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">alpha_n</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="n">v1</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-</span> <span class="n">Vt</span> <span class="o">-</span> <span class="mf">15.</span>
        <span class="k">return</span> <span class="mf">0.032</span><span class="o">*</span><span class="n">efun</span><span class="p">(</span><span class="o">-</span><span class="mf">0.2</span><span class="o">*</span><span class="n">v1</span><span class="p">)</span><span class="o">/</span><span class="mf">0.2</span>

    <span class="k">def</span> <span class="nf">beta_n</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="n">v1</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-</span> <span class="n">Vt</span> <span class="o">-</span> <span class="mf">10.</span>
        <span class="k">return</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">v1</span><span class="o">/</span><span class="mi">40</span><span class="p">)</span>

    <span class="c1"># steady-states and time constants</span>
    <span class="k">def</span> <span class="nf">tau_n</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
         <span class="k">return</span> <span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="n">alpha_n</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="n">beta_n</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
    <span class="k">def</span> <span class="nf">n_inf</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">alpha_n</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">alpha_n</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="n">beta_n</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
    <span class="k">def</span> <span class="nf">tau_m</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="n">alpha_m</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="n">beta_m</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
    <span class="k">def</span> <span class="nf">m_inf</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">alpha_m</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">alpha_m</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="n">beta_m</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
    <span class="k">def</span> <span class="nf">tau_h</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="n">alpha_h</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="n">beta_h</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
    <span class="k">def</span> <span class="nf">h_inf</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">alpha_h</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">alpha_h</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="n">beta_h</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>

    <span class="c1"># slow non-inactivating K+</span>
    <span class="k">def</span> <span class="nf">p_inf</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="n">v1</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="mf">35.</span>
        <span class="k">return</span> <span class="mf">1.0</span><span class="o">/</span><span class="p">(</span><span class="mf">1.</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.1</span><span class="o">*</span><span class="n">v1</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">tau_p</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="n">v1</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="mf">35.</span>
        <span class="k">return</span> <span class="n">tau_max</span><span class="o">/</span><span class="p">(</span><span class="mf">3.3</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mf">0.05</span><span class="o">*</span><span class="n">v1</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.05</span><span class="o">*</span><span class="n">v1</span><span class="p">))</span>


    <span class="c1">####################################</span>
    <span class="c1"># simulation from initial point</span>
    <span class="n">V</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="c1"># voltage</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="n">h</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

    <span class="n">V</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">V0</span><span class="p">)</span>
    <span class="n">n</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">n_inf</span><span class="p">(</span><span class="n">V</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">m_inf</span><span class="p">(</span><span class="n">V</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">h</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">h_inf</span><span class="p">(</span><span class="n">V</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">p_inf</span><span class="p">(</span><span class="n">V</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">tau_V_inv</span> <span class="o">=</span> <span class="p">(</span> <span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">gbar_Na</span><span class="o">*</span><span class="n">h</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="p">(</span><span class="n">n</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">4</span><span class="p">)</span><span class="o">*</span><span class="n">gbar_K</span><span class="o">+</span><span class="n">g_leak</span><span class="o">+</span><span class="n">gbar_M</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span><span class="o">/</span><span class="n">C</span>
        <span class="n">V_inf</span> <span class="o">=</span> <span class="p">(</span> <span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">gbar_Na</span><span class="o">*</span><span class="n">h</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">E_Na</span><span class="o">+</span><span class="p">(</span><span class="n">n</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">4</span><span class="p">)</span><span class="o">*</span><span class="n">gbar_K</span><span class="o">*</span><span class="n">E_K</span><span class="o">+</span><span class="n">g_leak</span><span class="o">*</span><span class="n">E_leak</span><span class="o">+</span><span class="n">gbar_M</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">E_K</span>
                <span class="o">+</span><span class="n">I</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">nois_fact</span><span class="o">*</span><span class="n">rng</span><span class="o">.</span><span class="n">randn</span><span class="p">()</span><span class="o">/</span><span class="p">(</span><span class="n">tstep</span><span class="o">**</span><span class="mf">0.5</span><span class="p">)</span> <span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">tau_V_inv</span><span class="o">*</span><span class="n">C</span><span class="p">)</span>
        <span class="n">V</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">V_inf</span> <span class="o">+</span> <span class="p">(</span><span class="n">V</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">V_inf</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">tstep</span><span class="o">*</span><span class="n">tau_V_inv</span><span class="p">)</span>
        <span class="n">n</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">n_inf</span><span class="p">(</span><span class="n">V</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">+</span><span class="p">(</span><span class="n">n</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">n_inf</span><span class="p">(</span><span class="n">V</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">tstep</span><span class="o">/</span><span class="n">tau_n</span><span class="p">(</span><span class="n">V</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
        <span class="n">m</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">m_inf</span><span class="p">(</span><span class="n">V</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">+</span><span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">m_inf</span><span class="p">(</span><span class="n">V</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">tstep</span><span class="o">/</span><span class="n">tau_m</span><span class="p">(</span><span class="n">V</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
        <span class="n">h</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">h_inf</span><span class="p">(</span><span class="n">V</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">+</span><span class="p">(</span><span class="n">h</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">h_inf</span><span class="p">(</span><span class="n">V</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">tstep</span><span class="o">/</span><span class="n">tau_h</span><span class="p">(</span><span class="n">V</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
        <span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">p_inf</span><span class="p">(</span><span class="n">V</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">+</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">p_inf</span><span class="p">(</span><span class="n">V</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">tstep</span><span class="o">/</span><span class="n">tau_p</span><span class="p">(</span><span class="n">V</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">V</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</pre></div>

<p>To get an idea of the output of the Hodgkin-Huxley model, let us generate some voltage traces for different parameters (<span class="arithmatex">\(\bar g_{Na}\)</span>,<span class="arithmatex">\(\bar g_K\)</span>), given the input current <span class="arithmatex">\(I_{\text{inj}}\)</span>:</p>
<div class="codehilite"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib</span> <span class="kn">as</span> <span class="nn">mpl</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>

<span class="c1"># input current, time step, time array</span>
<span class="n">I</span><span class="p">,</span> <span class="n">t_on</span><span class="p">,</span> <span class="n">t_off</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">A_soma</span> <span class="o">=</span> <span class="n">syn_current</span><span class="p">()</span>

<span class="c1"># simulate Hodgkin-Huxley model for 3 different parameter sets</span>
<span class="n">params</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[[</span><span class="mf">50.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">]],[[</span><span class="mf">4.</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">]],[[</span><span class="mf">20.</span><span class="p">,</span> <span class="mf">15.</span><span class="p">]]])</span>
<span class="n">num_samples</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span>
<span class="n">sim_samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num_samples</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">I</span><span class="p">)))</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_samples</span><span class="p">):</span>
    <span class="n">sim_samples</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">HHsimulator</span><span class="p">(</span><span class="n">V0</span><span class="o">=-</span><span class="mi">70</span><span class="p">,</span><span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="n">i</span><span class="p">,:],</span><span class="n">dt</span><span class="o">=</span><span class="n">dt</span><span class="p">,</span><span class="n">t</span><span class="o">=</span><span class="n">t</span><span class="p">,</span><span class="n">I</span><span class="o">=</span><span class="n">I</span><span class="p">,</span><span class="n">seed</span><span class="o">=</span><span class="bp">None</span><span class="p">)[:,</span><span class="mi">0</span><span class="p">]</span>


<span class="c1"># colors for traces</span>
<span class="n">col_min</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">num_colors</span> <span class="o">=</span> <span class="n">num_samples</span><span class="o">+</span><span class="n">col_min</span>
<span class="n">cm1</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">Blues</span>
<span class="n">col1</span> <span class="o">=</span> <span class="p">[</span><span class="n">cm1</span><span class="p">(</span><span class="mf">1.</span><span class="o">*</span><span class="n">i</span><span class="o">/</span><span class="n">num_colors</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">col_min</span><span class="p">,</span><span class="n">num_colors</span><span class="p">)]</span>

<span class="c1"># plotting</span>
<span class="o">%</span><span class="n">matplotlib</span> <span class="n">inline</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">gs</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">gridspec</span><span class="o">.</span><span class="n">GridSpec</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">height_ratios</span><span class="o">=</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_samples</span><span class="p">):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">sim_samples</span><span class="p">[</span><span class="n">i</span><span class="p">,:],</span><span class="n">color</span><span class="o">=</span><span class="n">col1</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;voltage (mV)&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([</span><span class="o">-</span><span class="mi">80</span><span class="p">,</span> <span class="o">-</span><span class="mi">20</span><span class="p">,</span> <span class="mi">40</span><span class="p">])</span>

<span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">I</span><span class="o">*</span><span class="n">A_soma</span><span class="o">*</span><span class="mf">1e3</span><span class="p">,</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;time (ms)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;input (nA)&#39;</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">t</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">t</span><span class="p">)])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.1</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">I</span><span class="o">*</span><span class="n">A_soma</span><span class="o">*</span><span class="mf">1e3</span><span class="p">)])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">mpl</span><span class="o">.</span><span class="n">ticker</span><span class="o">.</span><span class="n">FormatStrFormatter</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%.2f</span><span class="s1">&#39;</span><span class="p">))</span>
</pre></div>

<p><img alt="png" src="output_11_0.png" /></p>
<p>As can be seen, the voltage traces can be quite diverse for different parameter values. How can we infer the parameters (<span class="arithmatex">\(\bar g_{Na}\)</span>,<span class="arithmatex">\(\bar g_K\)</span>) underlying the particular observed voltage trace? <code>delfi</code> will allow us to solve this problem.</p>
<p>In order to run the Hodgkin-Huxley simulator within <code>delfi</code>, we need to define a simulator class linking to the simulator:</p>
<div class="codehilite"><pre><span></span><span class="kn">from</span> <span class="nn">delfi.simulator.BaseSimulator</span> <span class="kn">import</span> <span class="n">BaseSimulator</span>

<span class="k">class</span> <span class="nc">HodgkinHuxley</span><span class="p">(</span><span class="n">BaseSimulator</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">I</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">V0</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Hodgkin-Huxley simulator</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        I : array</span>
<span class="sd">            Numpy array with the input current</span>
<span class="sd">        dt : float</span>
<span class="sd">            Timestep</span>
<span class="sd">        V0 : float</span>
<span class="sd">            Voltage at first time step</span>
<span class="sd">        seed : int or None</span>
<span class="sd">            If set, randomness across runs is disabled</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dim_param</span> <span class="o">=</span> <span class="mi">2</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">dim_param</span><span class="o">=</span><span class="n">dim_param</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">I</span> <span class="o">=</span> <span class="n">I</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dt</span> <span class="o">=</span> <span class="n">dt</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">I</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">dt</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">HHsimulator</span> <span class="o">=</span> <span class="n">HHsimulator</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init</span> <span class="o">=</span> <span class="n">V0</span>

    <span class="k">def</span> <span class="nf">gen_single</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Forward model for simulator for single parameter set</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        params : list or np.array, 1d of length dim_param</span>
<span class="sd">            Parameter vector</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict : dictionary with data</span>
<span class="sd">            The dictionary must contain a key data that contains the results of</span>
<span class="sd">            the forward run. Additional entries can be present.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>

        <span class="k">assert</span> <span class="n">params</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;params.ndim must be 1&#39;</span>

        <span class="n">hh_seed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gen_newseed</span><span class="p">()</span>

        <span class="n">states</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">HHsimulator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">I</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="n">hh_seed</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="n">states</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span>
                <span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">,</span>
                <span class="s1">&#39;dt&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">,</span>
                <span class="s1">&#39;I&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">I</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)}</span>
</pre></div>

<p>Note that the simulator class simply wraps the simulator function we set up previously. <code>delfi</code> has the flexibility to use simulators that utilize external packages, e.g., Brian (<a href="http://briansimulator.org/">http://briansimulator.org/</a>), nest (<a href="https://www.nest-simulator.org/">https://www.nest-simulator.org/</a>), or NEURON (<a href="https://neuron.yale.edu/neuron/">https://neuron.yale.edu/neuron/</a>). External simulators do not need to be Python-based as long as they store simulation outputs in a format that can be read from Python.</p>
<h2 id="prior-over-model-parameters">Prior over model parameters<a class="headerlink" href="#prior-over-model-parameters" title="Permanent link">&para;</a></h2>
<p>Now that we have the model and simulator class, we need to define a function with the prior over the model parameters (<span class="arithmatex">\(\bar g_{Na}\)</span>,<span class="arithmatex">\(\bar g_K\)</span>), which in this case is chosen to be a Uniform distribution:</p>
<div class="codehilite"><pre><span></span><span class="kn">import</span> <span class="nn">delfi.distribution</span> <span class="kn">as</span> <span class="nn">dd</span>

<span class="n">seed_p</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">prior_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">.</span><span class="mi">5</span><span class="p">,</span><span class="mf">1e-4</span><span class="p">])</span>
<span class="n">prior_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">80.</span><span class="p">,</span><span class="mf">15.</span><span class="p">])</span>
<span class="n">prior</span> <span class="o">=</span> <span class="n">dd</span><span class="o">.</span><span class="n">Uniform</span><span class="p">(</span><span class="n">lower</span><span class="o">=</span><span class="n">prior_min</span><span class="p">,</span> <span class="n">upper</span><span class="o">=</span><span class="n">prior_max</span><span class="p">,</span><span class="n">seed</span><span class="o">=</span><span class="n">seed_p</span><span class="p">)</span>
</pre></div>

<h2 id="summary-statistics">Summary statistics<a class="headerlink" href="#summary-statistics" title="Permanent link">&para;</a></h2>
<p>We want to fit a set of summary statistics of the observed data: number of spikes, mean resting potential, standard deviation of the resting potential, and the first 4 voltage moments, mean, standard deviation, skewness and kurtosis. In order to do accomplish that, we define a summary statistics class which computes those quantities:</p>
<div class="codehilite"><pre><span></span><span class="kn">from</span> <span class="nn">delfi.summarystats.BaseSummaryStats</span> <span class="kn">import</span> <span class="n">BaseSummaryStats</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">stats</span> <span class="k">as</span> <span class="n">spstats</span>

<span class="k">class</span> <span class="nc">HodgkinHuxleyStats</span><span class="p">(</span><span class="n">BaseSummaryStats</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Moment based SummaryStats class for the Hodgkin-Huxley model</span>

<span class="sd">    Calculates summary statistics</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t_on</span><span class="p">,</span> <span class="n">t_off</span><span class="p">,</span> <span class="n">n_mom</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">n_summary</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;See SummaryStats.py for docstring&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">HodgkinHuxleyStats</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">t_on</span> <span class="o">=</span> <span class="n">t_on</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">t_off</span> <span class="o">=</span> <span class="n">t_off</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_mom</span> <span class="o">=</span> <span class="n">n_mom</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_summary</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">n_summary</span><span class="p">,</span><span class="n">n_mom</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">calc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">repetition_list</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calculate summary statistics</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        repetition_list : list of dictionaries, one per repetition</span>
<span class="sd">            data list, returned by `gen` method of Simulator instance</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        np.array, 2d with n_reps x n_summary</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">stats</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">repetition_list</span><span class="p">)):</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">repetition_list</span><span class="p">[</span><span class="n">r</span><span class="p">]</span>

            <span class="n">N</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span>
            <span class="n">dt</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;dt&#39;</span><span class="p">]</span>
            <span class="n">t_on</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t_on</span>
            <span class="n">t_off</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t_off</span>

            <span class="c1"># initialise array of spike counts</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">])</span>

            <span class="c1"># put everything to -10 that is below -10 or has negative slope</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">v</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">10</span><span class="p">)</span>
            <span class="n">v</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">10</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">v</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">10</span>

            <span class="c1"># remaining negative slopes are at spike peaks</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">spike_times</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">t</span><span class="p">)[</span><span class="n">ind</span><span class="p">]</span>
            <span class="n">spike_times_stim</span> <span class="o">=</span> <span class="n">spike_times</span><span class="p">[(</span><span class="n">spike_times</span> <span class="o">&gt;</span> <span class="n">t_on</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">spike_times</span> <span class="o">&lt;</span> <span class="n">t_off</span><span class="p">)]</span>

            <span class="c1"># number of spikes</span>
            <span class="k">if</span> <span class="n">spike_times_stim</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">spike_times_stim</span> <span class="o">=</span> <span class="n">spike_times_stim</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">spike_times_stim</span><span class="p">))</span><span class="o">&gt;</span><span class="mf">0.5</span><span class="p">]</span>

            <span class="c1"># resting potential and std</span>
            <span class="n">rest_pot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="n">t</span><span class="o">&lt;</span><span class="n">t_on</span><span class="p">])</span>
            <span class="n">rest_pot_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="nb">int</span><span class="p">(</span><span class="o">.</span><span class="mi">9</span><span class="o">*</span><span class="n">t_on</span><span class="o">/</span><span class="n">dt</span><span class="p">):</span><span class="nb">int</span><span class="p">(</span><span class="n">t_on</span><span class="o">/</span><span class="n">dt</span><span class="p">)])</span>

            <span class="c1"># moments</span>
            <span class="n">std_pw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][(</span><span class="n">t</span> <span class="o">&gt;</span> <span class="n">t_on</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">t</span> <span class="o">&lt;</span> <span class="n">t_off</span><span class="p">)]),</span>
                              <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">n_mom</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">n_mom</span><span class="o">-</span><span class="mi">2</span><span class="p">))</span>
            <span class="n">std_pw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="n">std_pw</span><span class="p">))</span>
            <span class="n">moments</span> <span class="o">=</span> <span class="n">spstats</span><span class="o">.</span><span class="n">moment</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][(</span><span class="n">t</span> <span class="o">&gt;</span> <span class="n">t_on</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">t</span> <span class="o">&lt;</span> <span class="n">t_off</span><span class="p">)],</span>
                                     <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">n_mom</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">n_mom</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">/</span><span class="n">std_pw</span>

            <span class="c1"># concatenation of summary statistics</span>
            <span class="n">sum_stats_vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">spike_times_stim</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]]),</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">rest_pot</span><span class="p">,</span><span class="n">rest_pot_std</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][(</span><span class="n">t</span> <span class="o">&gt;</span> <span class="n">t_on</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">t</span> <span class="o">&lt;</span> <span class="n">t_off</span><span class="p">)])]),</span>
                    <span class="n">moments</span>
                <span class="p">))</span>
            <span class="n">sum_stats_vec</span> <span class="o">=</span> <span class="n">sum_stats_vec</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">n_summary</span><span class="p">]</span>

            <span class="n">stats</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sum_stats_vec</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">stats</span><span class="p">)</span>
</pre></div>

<h2 id="generator-class">Generator class<a class="headerlink" href="#generator-class" title="Permanent link">&para;</a></h2>
<p>Now that we have the simulator class, the prior over parameters and the summary statistics class, we need to define a generator class that binds all these objects together:</p>
<div class="codehilite"><pre><span></span><span class="kn">import</span> <span class="nn">delfi.generator</span> <span class="kn">as</span> <span class="nn">dg</span>

<span class="c1"># input current, time step</span>
<span class="n">I</span><span class="p">,</span> <span class="n">t_on</span><span class="p">,</span> <span class="n">t_off</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">A_soma</span> <span class="o">=</span> <span class="n">syn_current</span><span class="p">()</span>

<span class="c1"># initial voltage</span>
<span class="n">V0</span> <span class="o">=</span> <span class="o">-</span><span class="mi">70</span>

<span class="c1"># seeds</span>
<span class="n">seed_m</span> <span class="o">=</span> <span class="mi">1</span>

<span class="c1"># summary statistics hyperparameters</span>
<span class="n">n_mom</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">n_summary</span> <span class="o">=</span> <span class="mi">7</span>

<span class="c1"># define model, prior, summary statistics and generator classes</span>
<span class="n">seed</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">m</span> <span class="o">=</span> <span class="n">HodgkinHuxley</span><span class="p">(</span><span class="n">I</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">V0</span><span class="o">=</span><span class="n">V0</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="n">seed_m</span><span class="p">)</span>
<span class="n">s</span> <span class="o">=</span> <span class="n">HodgkinHuxleyStats</span><span class="p">(</span><span class="n">t_on</span><span class="o">=</span><span class="n">t_on</span><span class="p">,</span> <span class="n">t_off</span><span class="o">=</span><span class="n">t_off</span><span class="p">,</span> <span class="n">n_mom</span><span class="o">=</span><span class="n">n_mom</span><span class="p">,</span> <span class="n">n_summary</span><span class="o">=</span><span class="n">n_summary</span><span class="p">)</span>
<span class="n">g</span> <span class="o">=</span> <span class="n">dg</span><span class="o">.</span><span class="n">Default</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">m</span><span class="p">,</span> <span class="n">prior</span><span class="o">=</span><span class="n">prior</span><span class="p">,</span> <span class="n">summary</span><span class="o">=</span><span class="n">s</span><span class="p">)</span>
</pre></div>

<p>Note that <code>delfi</code> allows for the use of multiprocessing tools to parallelise the simulations and increase the speed of simulations. As the simulations typically constitute the major computational burden in <code>SNPE</code>, we suggest the use of parallelisation. In order to accomplish that, we need to decide on the number of parallel processes (according to the computational resources available to the user - here we chose 10 parallel processes), define a list of as many models as the number of processes, and call <code>MPGenerator</code> class instead of <code>Default</code>:</p>
<div class="codehilite"><pre><span></span><span class="n">n_processes</span> <span class="o">=</span> <span class="mi">10</span>

<span class="n">seeds_m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">n_processes</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="n">m</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_processes</span><span class="p">):</span>
    <span class="n">m</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">HodgkinHuxley</span><span class="p">(</span><span class="n">I</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">V0</span><span class="o">=</span><span class="n">V0</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="n">seeds_m</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
<span class="n">g</span> <span class="o">=</span> <span class="n">dg</span><span class="o">.</span><span class="n">MPGenerator</span><span class="p">(</span><span class="n">models</span><span class="o">=</span><span class="n">m</span><span class="p">,</span> <span class="n">prior</span><span class="o">=</span><span class="n">prior</span><span class="p">,</span> <span class="n">summary</span><span class="o">=</span><span class="n">s</span><span class="p">)</span>
</pre></div>

<h2 id="coming-back-to-the-observed-data">Coming back to the observed data<a class="headerlink" href="#coming-back-to-the-observed-data" title="Permanent link">&para;</a></h2>
<p>As mentioned at the beginning of the tutorial, the observed data are generated by the Hodgkin-Huxley model with a set of known parameters (<span class="arithmatex">\(\bar g_{Na}\)</span>,<span class="arithmatex">\(\bar g_K\)</span>). To illustrate how to compute the summary statistics of the observed data, let us regenerate the observed data:</p>
<div class="codehilite"><pre><span></span><span class="c1"># true parameters and respective labels</span>
<span class="n">true_params</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">50.</span><span class="p">,</span> <span class="mf">5.</span><span class="p">])</span>       
<span class="n">labels_params</span> <span class="o">=</span> <span class="p">[</span><span class="sa">r</span><span class="s1">&#39;$g_{Na}$&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;$g_{K}$&#39;</span><span class="p">]</span>

<span class="c1"># observed data: simulation given true parameters</span>
<span class="n">obs</span> <span class="o">=</span> <span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">gen_single</span><span class="p">(</span><span class="n">true_params</span><span class="p">)</span>
</pre></div>

<p>Replotting the observed data with the respective current input:</p>
<div class="codehilite"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib</span> <span class="kn">as</span> <span class="nn">mpl</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>

<span class="o">%</span><span class="n">matplotlib</span> <span class="n">inline</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">gs</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">gridspec</span><span class="o">.</span><span class="n">GridSpec</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">height_ratios</span><span class="o">=</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">],</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;voltage (mV)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;observed data&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([</span><span class="o">-</span><span class="mi">80</span><span class="p">,</span> <span class="o">-</span><span class="mi">20</span><span class="p">,</span> <span class="mi">40</span><span class="p">])</span>

<span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">],</span><span class="n">I</span><span class="o">*</span><span class="n">A_soma</span><span class="o">*</span><span class="mf">1e3</span><span class="p">,</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;time (ms)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;input (nA)&#39;</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">])])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.1</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">I</span><span class="o">*</span><span class="n">A_soma</span><span class="o">*</span><span class="mf">1e3</span><span class="p">)])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">mpl</span><span class="o">.</span><span class="n">ticker</span><span class="o">.</span><span class="n">FormatStrFormatter</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%.2f</span><span class="s1">&#39;</span><span class="p">))</span>
</pre></div>

<p><img alt="png" src="output_27_0.png" /></p>
<p>Let us compute the summary statistics of the observed data:</p>
<div class="codehilite"><pre><span></span><span class="n">obs_stats</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">calc</span><span class="p">([</span><span class="n">obs</span><span class="p">])</span>
</pre></div>

<h1 id="inference">Inference<a class="headerlink" href="#inference" title="Permanent link">&para;</a></h1>
<p>Now that we have all the required components, we can run inference with <code>SNPE</code>. Let us start by defining the inference hyperparameters:</p>
<div class="codehilite"><pre><span></span><span class="n">seed_inf</span> <span class="o">=</span> <span class="mi">1</span>

<span class="n">pilot_samples</span> <span class="o">=</span> <span class="mi">2000</span>

<span class="c1"># training schedule</span>
<span class="n">n_train</span> <span class="o">=</span> <span class="mi">2000</span>
<span class="n">n_rounds</span> <span class="o">=</span> <span class="mi">1</span>

<span class="c1"># fitting setup</span>
<span class="n">minibatch</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">epochs</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">val_frac</span> <span class="o">=</span> <span class="mf">0.05</span>

<span class="c1"># network setup</span>
<span class="n">n_hiddens</span> <span class="o">=</span> <span class="p">[</span><span class="mi">50</span><span class="p">,</span><span class="mi">50</span><span class="p">]</span>

<span class="c1"># convenience</span>
<span class="n">prior_norm</span> <span class="o">=</span> <span class="bp">True</span>

<span class="c1"># MAF parameters</span>
<span class="n">density</span> <span class="o">=</span> <span class="s1">&#39;maf&#39;</span>
<span class="n">n_mades</span> <span class="o">=</span> <span class="mi">5</span>         <span class="c1"># number of MADES</span>
</pre></div>

<p>Note that we chose to run SNPE where the density estimator is a masked autoregressive flow (MAF). Another option could have been a mixture of Gaussians (see <a href="http://www.mackelab.org/delfi/reference/neuralnet/">http://www.mackelab.org/delfi/reference/neuralnet/</a>). We can now run the inference algorithm. Note that this step can take less than one minute to up to one hour depending on the computational resources available and the number of processes defined above:</p>
<div class="codehilite"><pre><span></span><span class="kn">import</span> <span class="nn">delfi.inference</span> <span class="kn">as</span> <span class="nn">infer</span>

<span class="c1"># inference object</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">infer</span><span class="o">.</span><span class="n">SNPEC</span><span class="p">(</span><span class="n">g</span><span class="p">,</span>
                <span class="n">obs</span><span class="o">=</span><span class="n">obs_stats</span><span class="p">,</span>
                <span class="n">n_hiddens</span><span class="o">=</span><span class="n">n_hiddens</span><span class="p">,</span>
                <span class="n">seed</span><span class="o">=</span><span class="n">seed_inf</span><span class="p">,</span>
                <span class="n">pilot_samples</span><span class="o">=</span><span class="n">pilot_samples</span><span class="p">,</span>
                <span class="n">n_mades</span><span class="o">=</span><span class="n">n_mades</span><span class="p">,</span>
                <span class="n">prior_norm</span><span class="o">=</span><span class="n">prior_norm</span><span class="p">,</span>
                <span class="n">density</span><span class="o">=</span><span class="n">density</span><span class="p">)</span>

<span class="c1"># train</span>
<span class="n">log</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">posterior</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
                    <span class="n">n_train</span><span class="o">=</span><span class="n">n_train</span><span class="p">,</span>
                    <span class="n">n_rounds</span><span class="o">=</span><span class="n">n_rounds</span><span class="p">,</span>
                    <span class="n">minibatch</span><span class="o">=</span><span class="n">minibatch</span><span class="p">,</span>
                    <span class="n">epochs</span><span class="o">=</span><span class="n">epochs</span><span class="p">,</span>
                    <span class="n">silent_fail</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                    <span class="n">proposal</span><span class="o">=</span><span class="s1">&#39;prior&#39;</span><span class="p">,</span>
                    <span class="n">val_frac</span><span class="o">=</span><span class="n">val_frac</span><span class="p">,</span>
                    <span class="n">verbose</span><span class="o">=</span><span class="bp">True</span><span class="p">,)</span>
</pre></div>

<p>Note that we chose the algorithm <code>SNPE-C</code>, but other algorithms are available within <code>delfi</code> (see <a href="http://www.mackelab.org/delfi/reference/inference/">http://www.mackelab.org/delfi/reference/inference/</a>). </p>
<h2 id="analysis-of-the-results">Analysis of the results<a class="headerlink" href="#analysis-of-the-results" title="Permanent link">&para;</a></h2>
<p>After running the inference algorithm, let us inspect and analyse the results. We can start by checking whether the algorithm training has converged by inspecting the respective loss function:</p>
<div class="codehilite"><pre><span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">log</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;loss&#39;</span><span class="p">],</span><span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;iteration&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;loss&#39;</span><span class="p">);</span>
</pre></div>

<p><img alt="png" src="output_37_0.png" /></p>
<p>It seems that the loss function has converged. Let us inspect the inferred posterior distribution over the parameters (<span class="arithmatex">\(\bar g_{Na}\)</span>,<span class="arithmatex">\(\bar g_K\)</span>):</p>
<div class="codehilite"><pre><span></span><span class="kn">from</span> <span class="nn">delfi.utils.viz</span> <span class="kn">import</span> <span class="n">samples_nd</span>

<span class="n">prior_min</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">prior</span><span class="o">.</span><span class="n">lower</span>
<span class="n">prior_max</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">prior</span><span class="o">.</span><span class="n">upper</span>
<span class="n">prior_lims</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">prior_min</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="n">prior_max</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)),</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">posterior_samples</span> <span class="o">=</span> <span class="n">posterior</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">gen</span><span class="p">(</span><span class="mi">10000</span><span class="p">)</span>

<span class="c1">###################</span>
<span class="c1"># colors</span>
<span class="n">hex2rgb</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">h</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">h</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">],</span> <span class="mi">16</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>

<span class="c1"># RGB colors in [0, 255]</span>
<span class="n">col</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">col</span><span class="p">[</span><span class="s1">&#39;GT&#39;</span><span class="p">]</span>      <span class="o">=</span> <span class="n">hex2rgb</span><span class="p">(</span><span class="s1">&#39;30C05D&#39;</span><span class="p">)</span>
<span class="n">col</span><span class="p">[</span><span class="s1">&#39;SNPE&#39;</span><span class="p">]</span>    <span class="o">=</span> <span class="n">hex2rgb</span><span class="p">(</span><span class="s1">&#39;2E7FE8&#39;</span><span class="p">)</span>
<span class="n">col</span><span class="p">[</span><span class="s1">&#39;SAMPLE1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hex2rgb</span><span class="p">(</span><span class="s1">&#39;8D62BC&#39;</span><span class="p">)</span>
<span class="n">col</span><span class="p">[</span><span class="s1">&#39;SAMPLE2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hex2rgb</span><span class="p">(</span><span class="s1">&#39;AF99EF&#39;</span><span class="p">)</span>

<span class="c1"># convert to RGB colors in [0, 1]</span>
<span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">col</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">col</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="n">i</span><span class="o">/</span><span class="mi">255</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">v</span><span class="p">])</span>

<span class="c1">###################</span>
<span class="c1"># posterior</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">samples_nd</span><span class="p">(</span><span class="n">posterior_samples</span><span class="p">,</span>
                       <span class="n">limits</span><span class="o">=</span><span class="n">prior_lims</span><span class="p">,</span>
                       <span class="n">ticks</span><span class="o">=</span><span class="n">prior_lims</span><span class="p">,</span>
                       <span class="n">labels</span><span class="o">=</span><span class="n">labels_params</span><span class="p">,</span>
                       <span class="n">fig_size</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span>
                       <span class="n">diag</span><span class="o">=</span><span class="s1">&#39;kde&#39;</span><span class="p">,</span>
                       <span class="n">upper</span><span class="o">=</span><span class="s1">&#39;kde&#39;</span><span class="p">,</span>
                       <span class="n">hist_diag</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;bins&#39;</span><span class="p">:</span> <span class="mi">50</span><span class="p">},</span>
                       <span class="n">hist_offdiag</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;bins&#39;</span><span class="p">:</span> <span class="mi">50</span><span class="p">},</span>
                       <span class="n">kde_diag</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;bins&#39;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span> <span class="s1">&#39;color&#39;</span><span class="p">:</span> <span class="n">col</span><span class="p">[</span><span class="s1">&#39;SNPE&#39;</span><span class="p">]},</span>
                       <span class="n">kde_offdiag</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;bins&#39;</span><span class="p">:</span> <span class="mi">50</span><span class="p">},</span>
                       <span class="n">points</span><span class="o">=</span><span class="p">[</span><span class="n">true_params</span><span class="p">],</span>
                       <span class="n">points_offdiag</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;markersize&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">},</span>
                       <span class="n">points_colors</span><span class="o">=</span><span class="p">[</span><span class="n">col</span><span class="p">[</span><span class="s1">&#39;GT&#39;</span><span class="p">]],</span>
                       <span class="n">title</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">);</span>
</pre></div>

<p><img alt="png" src="output_39_0.png" /></p>
<p>As can be seen, the inferred posterior contains the ground-truth parameters (green) in a high-probability region. Now, let us sample parameters from the posterior distribution, simulate the Hodgkin-Huxley model for each of those samples and compare the simulations with the observed data:</p>
<div class="codehilite"><pre><span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>

<span class="n">y_obs</span> <span class="o">=</span> <span class="n">obs</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">obs</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span>
<span class="n">duration</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

<span class="n">num_samp</span> <span class="o">=</span> <span class="mi">2</span>

<span class="c1"># sample from posterior</span>
<span class="n">x_samp</span> <span class="o">=</span> <span class="n">posterior</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">gen</span><span class="p">(</span><span class="n">n_samples</span><span class="o">=</span><span class="n">num_samp</span><span class="p">)</span>

<span class="c1"># reject samples for which prior is zero</span>
<span class="n">ind</span> <span class="o">=</span> <span class="p">(</span><span class="n">x_samp</span> <span class="o">&gt;</span> <span class="n">prior_min</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">x_samp</span> <span class="o">&lt;</span> <span class="n">prior_max</span><span class="p">)</span>
<span class="n">params</span> <span class="o">=</span> <span class="n">x_samp</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">ind</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">]</span>

<span class="n">num_samp</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span>

<span class="c1"># simulate and plot samples</span>
<span class="n">V</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">),</span><span class="n">num_samp</span><span class="p">))</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_samp</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">gen_single</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="n">i</span><span class="p">,:])</span>
    <span class="n">V</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">V</span><span class="p">[:,</span> <span class="n">i</span><span class="p">],</span> <span class="n">color</span> <span class="o">=</span> <span class="n">col</span><span class="p">[</span><span class="s1">&#39;SAMPLE&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)],</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;sample &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">num_samp</span><span class="o">-</span><span class="n">i</span><span class="p">))</span>

<span class="c1"># plot observation</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">y_obs</span><span class="p">,</span> <span class="s1">&#39;--&#39;</span><span class="p">,</span><span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;observation&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;time (ms)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;voltage (mV)&#39;</span><span class="p">)</span>

<span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
<span class="n">handles</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_legend_handles_labels</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">labels</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.3</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper right&#39;</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">duration</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">duration</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([</span><span class="o">-</span><span class="mi">80</span><span class="p">,</span> <span class="o">-</span><span class="mi">20</span><span class="p">,</span> <span class="mi">40</span><span class="p">]);</span>
</pre></div>

<p><img alt="png" src="output_41_0.png" /></p>
<p>As can be seen, the samples from the inferred posterior lead to simulations that closely resemble the observed data, confirming that <code>SNPE-C</code> did a good job at capturing the observed data.</p>
<h2 id="references">References<a class="headerlink" href="#references" title="Permanent link">&para;</a></h2>
<p>A. L. Hodgkin and A. F. Huxley. A quantitative description of membrane current and its application to conduction and excitation in nerve. The Journal of Physiology, 117(4):500544, 1952.</p>
<p>M. Pospischil, M. Toledo-Rodriguez, C. Monier, Z. Piwkowska, T. Bal, Y. Frgnac, H. Markram, and A. Destexhe. Minimal Hodgkin-Huxley type models for different classes of cortical and thalamic neurons. Biological Cybernetics, 99(4-5), 2008.</p>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../../install/" title="Installation" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Installation
              </span>
            </div>
          </a>
        
        
          <a href="../../reference/distributions/" title="Distributions" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Distributions
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
  <div class="md-footer-social">
    <link rel="stylesheet" href="../../assets/fonts/font-awesome.css">
    
      <a href="https://github.com/mackelab/delfi" class="md-footer-social__link fa fa-github"></a>
    
  </div>

    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/application.ac79c3b0.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:"../.."}})</script>
      
        <script src="https://cdn.jsdelivr.net/npm/katex@0.10.2/dist/katex.min.js"></script>
      
        <script src="../../static/katex.js"></script>
      
        <script src="../../static/nav.js"></script>
      
    
  </body>
</html>